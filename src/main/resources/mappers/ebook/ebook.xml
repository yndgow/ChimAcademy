<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.ChimAcademy.dao.EbookDAO">	
	<insert id="insertEbook">
		insert into `ebook` set
							`bookId`=#{bookId}, 
							`GROUP`=#{GROUP}, 
							`cate1`=#{cate1}, 
							`cate2`=#{cate2}, 
							`title`=#{title}, 
							`author`=#{author}, 
							`publisher`=#{publisher}, 
							`belong`=#{belong}, 
							`applier`=#{applier}, 
							`pubDate`=#{pubDate}, 
							`bintro`=#{bintro}, 
							`aintro`=#{aintro}, 
							`index`=#{index}, 
							`thumb`=#{thumb},
							`rdate`=now();
	</insert>
	<insert id="insertEbookFile">
		insert into `ebook_file` set 
								`parent`=#{parent}, 
								`newName`=#{newName}, 
								`oriName`=#{oriName}, 
								`rdate`=now();
	</insert>
	<insert id="insertMylib">
		insert into `mylib` set 
							`uid`=#{uid}, 
							`bookId`=#{bookId}, 
							`state`=#{state}, 
							`loanDate`=now(),
							`returnDate`= date_add(now(), interval 14 day);
	</insert>
	<select id="selectEbook" resultType="kr.co.ChimAcademy.vo.EbookVO">
		select a.*,b.c1Name,c.c2Name from `ebook` as a
								JOIN `ebook_cate1` AS b 
								ON a.`cate1`=b.`c1`
								JOIN `ebook_cate2` AS c
								ON a.`cate1`=c.`c1` AND  a.`cate2`=c.`c2`
								where `bookId`=#{bookId};
	</select>
	<select id="selectEbookFile" resultType="kr.co.ChimAcademy.vo.EbookFileVO">
		select * from `ebook_file` where `parent`=#{bookId};
	</select>
	<select id="selectEbooks" resultType="kr.co.ChimAcademy.vo.EbookVO">
		select * from `ebook` order by `rdate` DESC LIMIT 10;
	</select>
 	<resultMap id="selectMylibsResultMap" type="kr.co.ChimAcademy.vo.MylibVO">
		<id column="no" property="no"/>
		<result column="uid" property="uid"/>
		<result column="bookId" property="bookId"/>
		<result column="state" property="state"/>
		<result column="loanDate" property="loanDate"/>
		<result column="returnDate" property="returnDate"/>
		<result column="returnReal" property="returnReal"/>
		<association property="EbookVO" javaType="kr.co.ChimAcademy.vo.EbookVO">
			<id column="bookId" property="bookId"/>
			<result column="title" property="title"/>
			<result column="author" property="author"/>
			<result column="publisher" property="publisher"/>
			<result column="belong" property="belong"/>
			<result column="applier" property="applier"/>
			<result column="pubDate" property="pubDate"/>
			<result column="thumb" property="thumb"/>
		</association>
	</resultMap>
	<select id="selectMylibs" resultMap="selectMylibsResultMap">
		SELECT a.*, b.title,b.author,b.publisher,b.belong,b.applier,b.pubDate,b.thumb FROM `mylib` AS a 
													JOIN `ebook` AS b
													ON a.`bookId`=b.`bookId`
													where a.uid=#{uid} and a.state=1;
	</select>
	<select id="selectCountEbook" resultType="int">
		select count(*) from `ebook` where `cate1`=#{cate1} and `cate2`=#{cate2}; 
	</select>
	<select id="selectCate1s" resultType="kr.co.ChimAcademy.vo.EbookCate1VO">
		select * from `ebook_cate1`;
	</select>
	<select id="selectCate2s" resultType="kr.co.ChimAcademy.vo.EbookCate2VO">
		select * from `ebook_cate2` where `c1`=#{c1};
	</select>
	<update id="updateEbookDown">
		update `ebook_file` set `download` = `download`+1 where `parent`=#{bookId};
	</update>
</mapper>